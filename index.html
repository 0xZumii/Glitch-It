<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Glitch It</title>
<style>
  body { background:#111; color:#fff; font-family:sans-serif; text-align:center; padding:20px; }
  canvas { border:2px solid #fff; margin-top:12px; max-width:90%; }
  .controls { margin-top:12px; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
  label { display:flex; flex-direction:column; align-items:center; font-size:0.9rem; }
  input[type=range] { width:120px; }
  button { padding:8px 14px; cursor:pointer; background:#222; border:2px solid #fff; border-radius:6px; color:#fff; }
</style>
</head>
<body>
<h1>Glitch It</h1>
<input type="file" id="fileInput"><br>

<div class="controls">
  <label>RGB Shift <input type="range" id="rgbShift" min="0" max="20" value="5"></label>
  <label>Slice Shift <input type="range" id="sliceShift" min="0" max="50" value="10"></label>
  <label>Noise <input type="range" id="noise" min="0" max="0.2" step="0.01" value="0.02"></label>
  <label>Scanline <input type="range" id="scanline" min="0" max="10" value="2"></label>
  <button id="exportBtn">Export PNG</button>
</div>

<canvas id="canvas"></canvas>

<script>
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  img.src = url;
});

img.onload = ()=>{
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img,0,0);
};

const rgbShiftSlider = document.getElementById('rgbShift');
const sliceShiftSlider = document.getElementById('sliceShift');
const noiseSlider = document.getElementById('noise');
const scanlineSlider = document.getElementById('scanline');

function applyGlitch(){
  if(!img.src) return;
  ctx.drawImage(img,0,0);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imageData.data;
  const width = canvas.width;
  const height = canvas.height;

  const rgbShift = parseInt(rgbShiftSlider.value);
  const sliceShift = parseInt(sliceShiftSlider.value);
  const noiseAmount = parseFloat(noiseSlider.value);
  const scanline = parseInt(scanlineSlider.value);

  // RGB offset + noise
  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      const i = (y*width + x)*4;
      // RGB shift
      if(x+rgbShift<width){
        data[i] = data[i + 4*rgbShift];     // R
        data[i+1] = data[i + 4*rgbShift+1]; // G
        data[i+2] = data[i + 4*rgbShift+2]; // B
      }
      // Noise
      if(Math.random()<noiseAmount){
        data[i] = 255*Math.random();
        data[i+1] = 255*Math.random();
        data[i+2] = 255*Math.random();
      }
    }
  }

  // Slice shift
  for(let y=0;y<height;y+=Math.max(1,rand(5,20))){
    const shiftX = Math.floor((Math.random()-0.5)*sliceShift*2);
    if(shiftX === 0) continue;
    const rowStart = y*width*4;
    const rowEnd = rowStart + width*4;
    const row = data.slice(rowStart,rowEnd);
    for(let x=0;x<width;x++){
      const srcIdx = clamp(x-shiftX,0,width-1)*4;
      const dstIdx = x*4;
      data[rowStart + dstIdx] = row[srcIdx];
      data[rowStart + dstIdx+1] = row[srcIdx+1];
      data[rowStart + dstIdx+2] = row[srcIdx+2];
    }
  }

  // Scanlines
  for(let y=0;y<height;y+=scanline*2){
    for(let x=0;x<width;x++){
      const i = (y*width + x)*4;
      data[i]*=0.7; data[i+1]*=0.7; data[i+2]*=0.7;
    }
  }

  ctx.putImageData(imageData,0,0);
}

function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

// Update glitch live
[rgbShiftSlider,sliceShiftSlider,noiseSlider,scanlineSlider].forEach(slider=>{
  slider.addEventListener('input', applyGlitch);
});

// Export
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const link = document.createElement('a');
  link.download = 'glitched.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});
</script>
</body>
</html>
